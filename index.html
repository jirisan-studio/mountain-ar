<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì§€ë¦¬ì‚° AR ê°€ì´ë“œ</title>

    <!-- A-Frame & AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        
        /* UI ì»¨í…Œì´ë„ˆ - ê°€ë¡œ/ì„¸ë¡œ ëª¨ë‘ ê½‰ ì°¨ê²Œ */
        #ui-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* ë””ë²„ê·¸ íŒ¨ë„ (GPS ìˆ˜ì‹  í™•ì¸ìš©) */
        #debug-panel {
            background: rgba(0, 0, 0, 0.5);
            color: lime;
            padding: 10px;
            font-size: 12px;
            text-align: left;
            pointer-events: auto;
            position: absolute;
            top: 10px;
            left: 10px;
            border-radius: 5px;
        }

        /* ìŠ¬ë¼ì´ë” ì˜ì—­ */
        .slider-wrapper {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 200px; /* ê³ ì • ë†’ì´ */
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 10px 5px;
        }

        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        input[type=range] {
            writing-mode: bt-lr; /* IE/Edge */
            -webkit-appearance: slider-vertical; /* WebKit */
            width: 8px;
            height: 100%;
        }

        .range-label {
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px black;
        }

        /* ìº¡ì³ ë²„íŠ¼ */
        #capture-btn {
            position: absolute;
            left: 20px;
            bottom: 30px;
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            border: 4px solid rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        #capture-btn:active { transform: scale(0.95); background-color: #eee; }

        /* ê°€ë¡œ ëª¨ë“œì¼ ë•Œ UI ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì • */
        @media (orientation: landscape) {
            .slider-wrapper {
                right: 40px; /* ì˜¤ë¥¸ìª½ ì—¬ë°± í™•ë³´ */
            }
            #capture-btn {
                bottom: 20px;
                left: 40px;
            }
        }
    </style>
</head>

<body>
    <!-- AR ì”¬ -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="logarithmicDepthBuffer: true; precision: medium;">

        <!-- GPS ì¹´ë©”ë¼ (minDistance: ë„ˆë¬´ ê°€ê¹Œìš°ë©´ ì•ˆë³´ì„ ë°©ì§€) -->
        <a-camera gps-camera="minDistance: 5;" rotation-reader></a-camera>
        
        <!-- ë´‰ìš°ë¦¬ ì»¨í…Œì´ë„ˆ -->
        <a-entity id="places-container"></a-entity>
    </a-scene>

    <!-- UI ë ˆì´ì–´ -->
    <div id="ui-container">
        <!-- ë””ë²„ê·¸ íŒ¨ë„ -->
        <div id="debug-panel">
            GPS ì‹ í˜¸ ì°¾ëŠ” ì¤‘...<br>
            (íƒ íŠ¸ì¸ ì•¼ì™¸ë¡œ ë‚˜ê°€ì£¼ì„¸ìš”)
        </div>

        <!-- ìŠ¬ë¼ì´ë” -->
        <div class="slider-wrapper">
            <div class="range-label"><span id="range-val">50</span>km</div>
            <input type="range" id="dist-slider" min="0" max="50" value="50" step="1">
        </div>

        <!-- ìº¡ì³ ë²„íŠ¼ -->
        <button id="capture-btn">ğŸ“·</button>
    </div>

    <script>
        // â˜… ë°ì´í„° ìˆ˜ì •: ì§€ë¦¬ì‚° ë…¸ê³ ë‹¨ ì¢Œí‘œ ì¶”ê°€ â˜…
        const mountainData = [
            // ì‹¤ì œ ì§€ë¦¬ì‚° ë…¸ê³ ë‹¨ ì¢Œí‘œ (êµ¬ê¸€ì§€ë„ ê¸°ì¤€)
            { name: "ì§€ë¦¬ì‚° ë…¸ê³ ë‹¨", lat: 35.2938, lng: 127.5332, alt: 1507 },
            
            // í…ŒìŠ¤íŠ¸ìš©: í˜„ì¬ ìœ„ì¹˜ê°€ ì–´ë””ë“  ë°”ë¡œ ë¶ìª½ì— í•˜ë‚˜ ë„ìš°ê¸° ìœ„í•œ ê°€ì§œ ë°ì´í„° (ì—…ë°ì´íŠ¸ ì‹œ ìœ„ì¹˜ ë®ì–´ì”Œì›€)
            { name: "í…ŒìŠ¤íŠ¸(ë¶ìª½ë°©í–¥)", lat: 0, lng: 0, alt: 100 } 
        ];

        let userLat = 0;
        let userLng = 0;

        window.onload = () => {
            const slider = document.getElementById('dist-slider');
            slider.addEventListener('input', updateVisibleRange);
            document.getElementById('capture-btn').addEventListener('click', takeScreenshot);

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    
                    // ë””ë²„ê·¸ íŒ¨ë„ì— ë‚´ ì¢Œí‘œ í‘œì‹œ
                    document.getElementById('debug-panel').innerHTML = 
                        `ë‚´ ìœ„ì¹˜:<br>ìœ„ë„ ${userLat.toFixed(5)}<br>ê²½ë„ ${userLng.toFixed(5)}<br>ì •í™•ë„: ${position.coords.accuracy}m`;

                    // ìµœì´ˆ 1íšŒ, í…ŒìŠ¤íŠ¸ ë°ì´í„°ì˜ ì¢Œí‘œë¥¼ ë‚´ ìœ„ì¹˜ ë°”ë¡œ ë¶ìª½(ìœ„ë„+0.005)ìœ¼ë¡œ ë³€ê²½í•´ì„œ 
                    // ë¬´ì¡°ê±´ í™”ë©´ì— ë­ë¼ë„ í•˜ë‚˜ ëœ¨ê²Œ ë§Œë“¦ (í…ŒìŠ¤íŠ¸ìš©)
                    if(mountainData[1].lat === 0) {
                        mountainData[1].lat = userLat + 0.005; // ë¶ìª½ ì•½ 500m
                        mountainData[1].lng = userLng;
                        renderPlaces(slider.value);
                    } else {
                        renderPlaces(slider.value);
                    }

                }, error => {
                    document.getElementById('debug-panel').innerText = "GPS ê¶Œí•œ ê±°ë¶€ë¨. ì„¤ì • í™•ì¸ í•„ìš”.";
                    alert("ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ARì´ ì‘ë™í•©ë‹ˆë‹¤.");
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 27000
                });
            }
        };

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function renderPlaces(rangeKm) {
            const container = document.getElementById('places-container');
            container.innerHTML = ''; 
            
            // ë””ë²„ê·¸ íŒ¨ë„ì— ê±°ë¦¬ ì •ë³´ë¥¼ ë„ìš°ê¸° ìœ„í•œ ë³€ìˆ˜
            let debugText = document.getElementById('debug-panel').innerHTML.split('<br>---')[0]; // ê¸°ì¡´ GPS ì •ë³´ ìœ ì§€
            debugText += "<br>---<br>";

            mountainData.forEach(place => {
                const dist = calculateDistance(userLat, userLng, place.lat, place.lng);

                // í™”ë©´ì— ê±°ë¦¬ ì •ë³´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
                debugText += `${place.name}: ${dist.toFixed(1)}km<br>`;

                // ë²”ìœ„ ë‚´ì— ìˆìœ¼ë©´ ìƒì„±
                if (dist <= rangeKm) {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gps-entity-place', `latitude: ${place.lat}; longitude: ${place.lng};`);
                    entity.setAttribute('look-at', '[gps-camera]');
                    
                    // â˜…ìˆ˜ì •: ê±°ë¦¬ì— ë”°ë¼ í¬ê¸°(Scale)ë¥¼ íšê¸°ì ìœ¼ë¡œ í‚¤ì›€
                    // 10km ì´ìƒ ë©€ì–´ì§€ë©´ í›¨ì”¬ í¬ê²Œ ë³´ì´ê²Œ ì„¤ì •
                    let scaleSize = 20; 
                    if(dist > 10) scaleSize = dist * 2; // ê±°ë¦¬ê°€ ë©€ìˆ˜ë¡ ë” ì»¤ì§€ê²Œ (ë¹„ë¡€ì‹)
                    
                    entity.setAttribute('scale', `${scaleSize} ${scaleSize} ${scaleSize}`);

                    // 1. í•€ (ì—­ì‚¼ê°í˜•)
                    const cone = document.createElement('a-cone');
                    cone.setAttribute('color', 'red');
                    cone.setAttribute('radius-bottom', '0.5');
                    cone.setAttribute('radius-top', '2');
                    cone.setAttribute('height', '4');
                    cone.setAttribute('position', `0 ${scaleSize} 0`); // í¬ê¸°ì— ë§ì¶° ë†’ì´ ì¡°ì ˆ
                    
                    // 2. í…ìŠ¤íŠ¸
                    const text = document.createElement('a-text');
                    text.setAttribute('value', `${place.name}\n${dist.toFixed(1)}km`);
                    text.setAttribute('align', 'center');
                    text.setAttribute('color', 'yellow'); // ì˜ ë³´ì´ê²Œ ë…¸ë€ìƒ‰
                    text.setAttribute('position', `0 ${scaleSize + 5} 0`);
                    
                    entity.appendChild(cone);
                    entity.appendChild(text);
                    container.appendChild(entity);
                }
            });
            
            // ë””ë²„ê·¸ íŒ¨ë„ ì—…ë°ì´íŠ¸
            document.getElementById('debug-panel').innerHTML = debugText;
            document.getElementById('range-val').innerText = rangeKm;
        }

        function updateVisibleRange(e) {
            const range = e.target.value;
            renderPlaces(range);
        }

        function takeScreenshot() {
            const ui = document.getElementById('ui-container');
            ui.style.display = 'none';
            setTimeout(() => {
                ui.style.display = 'flex';
            }, 3000);
            // alert("ìº¡ì³ë¥¼ ìœ„í•´ UIë¥¼ ì ì‹œ ìˆ¨ê¹ë‹ˆë‹¤.");
        }
    </script>
</body>
</html>