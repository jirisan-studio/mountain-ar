<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100ëŒ€ ëª…ì‚° AR ê°€ì´ë“œ</title>

    <!-- A-Frame & AR.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        /* ê¸°ë³¸ UI ìŠ¤íƒ€ì¼ */
        body { margin: 0; overflow: hidden; font-family: 'Malgun Gothic', sans-serif; }
        
        /* UI ì˜¤ë²„ë ˆì´ ì»¨í…Œì´ë„ˆ */
        #ui-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* AR í™”ë©´ í„°ì¹˜ ë°©í•´ ì•ˆ í•¨ */
            z-index: 10;
        }

        /* 1. ê±°ë¦¬ ì¡°ì ˆ ìŠ¬ë¼ì´ë” (ì˜¤ë¥¸ìª½ ì„¸ë¡œ ë°°ì¹˜) */
        .slider-wrapper {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
        }

        /* ìŠ¬ë¼ì´ë” ì„¸ë¡œ íšŒì „ íŠ¸ë¦­ */
        input[type=range] {
            writing-mode: bt-lr; /* IE/Edge */
            -webkit-appearance: slider-vertical; /* WebKit */
            width: 8px;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
        }

        .range-label {
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: center;
        }

        /* 2. ìº¡ì³ ë²„íŠ¼ (ì™¼ìª½ í•˜ë‹¨) */
        #capture-btn {
            position: absolute;
            left: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            border: 4px solid rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        #capture-btn:active { background-color: #ddd; }

        /* AR í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (JSì—ì„œ ì‚¬ìš©) */
        .ar-text {
            font-size: 50px; /* A-frame text scale ì¡°ì ˆ í•„ìš” */
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">

    <!-- AR ì”¬ (Scene) ì„¤ì • -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="logarithmicDepthBuffer: true;">

        <!-- ì¹´ë©”ë¼ ë° GPS ì—°ë™ -->
        <a-camera gps-camera rotation-reader></a-camera>
        
        <!-- ì—¬ê¸°ì— JSë¡œ ë´‰ìš°ë¦¬ë“¤ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        <a-entity id="places-container"></a-entity>
    </a-scene>

    <!-- UI ë ˆì´ì–´ -->
    <div id="ui-container">
        <!-- ìŠ¬ë¼ì´ë” êµ¬ì—­ -->
        <div class="slider-wrapper">
            <div class="range-label"><span id="range-val">50</span>km</div>
            <!-- 0km ~ 50km, ê¸°ë³¸ê°’ 50km -->
            <input type="range" id="dist-slider" min="0" max="50" value="50" step="1">
        </div>

        <!-- ìº¡ì³ ë²„íŠ¼ -->
        <button id="capture-btn">ğŸ“·</button>
    </div>

    <script>
        // [Aë°©ì‹] ë°ì´í„° ì¤€ë¹„ (ìƒ˜í”Œ ë°ì´í„° - ë¬¸ì„œì— ìˆëŠ” ëŒ€ë‘”ì‚° + í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ë°ì´í„°)
        // ì‹¤ì œë¡œëŠ” APIì—ì„œ ë°›ì€ 960ê°œì˜ ë°ì´í„°ë¥¼ ì´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ì„œ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
        const mountainData = [
            { name: "ëŒ€ë‘”ì‚°(ì •ìƒ)", lat: 36.124691, lng: 127.320518, alt: 878 }, 
            { name: "ì„œìš¸ ë‚¨ì‚°(í…ŒìŠ¤íŠ¸)", lat: 37.551169, lng: 126.988227, alt: 262 },
            { name: "ë¶í•œì‚° ë°±ìš´ëŒ€(í…ŒìŠ¤íŠ¸)", lat: 37.652511, lng: 126.974914, alt: 836 },
            { name: "ìš°ë¦¬ì§‘ ì•ë§ˆë‹¹(í…ŒìŠ¤íŠ¸ìš© - í˜„ì¬ ìœ„ì¹˜ ê·¼ì²˜ ì¢Œí‘œë¡œ ìˆ˜ì • í•„ìš”)", lat: 37.500000, lng: 127.000000, alt: 100 } 
        ];

        let userLat = 0;
        let userLng = 0;

        // 1. ì´ˆê¸°í™” ë° ì‚¬ìš©ì ìœ„ì¹˜ íŒŒì•…
        window.onload = () => {
            // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            const slider = document.getElementById('dist-slider');
            slider.addEventListener('input', updateVisibleRange);

            // ìº¡ì³ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
            document.getElementById('capture-btn').addEventListener('click', takeScreenshot);

            // ì‚¬ìš©ì GPS ìœ„ì¹˜ ì¶”ì  ì‹œì‘
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    
                    // ìœ„ì¹˜ê°€ ì—…ë°ì´íŠ¸ ë  ë•Œë§ˆë‹¤ AR ê°ì²´ ê±°ë¦¬ ê³„ì‚° í›„ ë Œë”ë§
                    renderPlaces(slider.value);
                }, error => {
                    alert("GPS ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                }, {
                    enableHighAccuracy: true
                });
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        };

        // 2. ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine Formula) - ë‹¨ìœ„: km
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // 3. AR ê°ì²´ ë Œë”ë§ ë° í•„í„°ë§
        function renderPlaces(rangeKm) {
            const container = document.getElementById('places-container');
            
            // ê¸°ì¡´ ì•„ì´í…œë“¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ë˜ëŠ” ê±°ë¦¬ ì²´í¬ (ì„±ëŠ¥ì„ ìœ„í•´ ì „ì²´ ì‚­ì œ í›„ ì¬ìƒì„±ì€ ì§€ì–‘í•´ì•¼ í•˜ë‚˜ ê°„í¸í•œ êµ¬í˜„ì„ ìœ„í•´ ì—¬ê¸°ì„  ì´ˆê¸°í™” ë°©ì‹ì„ ì”ë‹ˆë‹¤)
            // ì‹¤ì œ ìƒìš©í™” ì‹œì—ëŠ” visible ì†ì„±ë§Œ í† ê¸€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
            container.innerHTML = ''; 

            mountainData.forEach(place => {
                const dist = calculateDistance(userLat, userLng, place.lat, place.lng);

                // ìŠ¬ë¼ì´ë” ë²”ìœ„ ì•ˆì— ìˆëŠ” ì‚°ë§Œ í‘œì‹œ
                if (dist <= rangeKm) {
                    // A-Frame ì—”í‹°í‹° ìƒì„±
                    const entity = document.createElement('a-entity');
                    
                    // GPS ì¢Œí‘œ ì„¤ì •
                    entity.setAttribute('gps-entity-place', `latitude: ${place.lat}; longitude: ${place.lng};`);
                    
                    // í•­ìƒ ì‚¬ìš©ìë¥¼ ë°”ë¼ë³´ê²Œ ì„¤ì •
                    entity.setAttribute('look-at', '[gps-camera]');

                    // í…ìŠ¤íŠ¸ ë° ë””ìì¸ ì„¤ì • (í•€ ëª¨ì–‘)
                    // ê±°ë¦¬ í‘œì‹œ (ì†Œìˆ˜ì  1ìë¦¬)
                    const distText = dist.toFixed(1) + "km";
                    
                    // ë¹¨ê°„ìƒ‰ í•€ ëª¨ì–‘ (ì›ë¿”)
                    const cone = document.createElement('a-cone');
                    cone.setAttribute('color', 'red');
                    cone.setAttribute('radius-bottom', '1'); // í¬ê¸° ì¡°ì ˆ í•„ìš” ì‹œ ìˆ˜ì •
                    cone.setAttribute('radius-top', '0.1');
                    cone.setAttribute('height', '3');
                    cone.setAttribute('position', '0 5 0'); // ê³µì¤‘ì— ë„ì›€
                    
                    // í…ìŠ¤íŠ¸ ë¼ë²¨ (ì‚° ì´ë¦„ + ê±°ë¦¬)
                    const text = document.createElement('a-text');
                    text.setAttribute('value', `${place.name}\n${distText}`);
                    text.setAttribute('align', 'center');
                    text.setAttribute('color', 'yellow');
                    text.setAttribute('scale', '15 15 15'); // í…ìŠ¤íŠ¸ í¬ê¸°
                    text.setAttribute('position', '0 8 0'); // í•€ ìœ„ì— ê¸€ì”¨

                    entity.appendChild(cone);
                    entity.appendChild(text);
                    container.appendChild(entity);
                }
            });

            // ìŠ¬ë¼ì´ë” UI í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('range-val').innerText = rangeKm;
        }

        // ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ í˜¸ì¶œ
        function updateVisibleRange(e) {
            const range = e.target.value;
            document.getElementById('range-val').innerText = range;
            renderPlaces(range);
        }

        // 4. í™”ë©´ ìº¡ì³ ê¸°ëŠ¥
        function takeScreenshot() {
            // WebARì—ì„œ ìº¡ì³ëŠ” ë³´ì•ˆ ë° ê¸°ìˆ ì  ì´ìŠˆ(ì¹´ë©”ë¼ í”¼ë“œ ìº¡ì³ ë¶ˆê°€)ê°€ ë§ìŠµë‹ˆë‹¤.
            // ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•ì€ UIë¥¼ ì ì‹œ ìˆ¨ê²¨ì„œ ì‚¬ìš©ìê°€ ì§ì ‘ í°ì˜ ìº¡ì³ ê¸°ëŠ¥ì„ ì“°ê²Œ í•˜ê±°ë‚˜,
            // í˜„ì¬ í™”ë©´ì˜ ìº”ë²„ìŠ¤ë§Œ ì €ì¥í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” "UI ìˆ¨ê¸°ê¸° ëª¨ë“œ"ë¡œ ì•ˆë‚´í•˜ì—¬ ê¹”ë”í•œ ìº¡ì³ë¥¼ ìœ ë„í•˜ëŠ” ë°©ì‹ì„ ì¶”ì²œí•©ë‹ˆë‹¤.
            
            const ui = document.getElementById('ui-container');
            const btn = document.getElementById('capture-btn');
            
            // UI ìˆ¨ê¸°ê¸°
            ui.style.display = 'none';
            
            // 3ì´ˆ ë’¤ì— UI ë‹¤ì‹œ í‘œì‹œ
            setTimeout(() => {
                ui.style.display = 'block';
                alert("UIê°€ ë‹¤ì‹œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }, 3000);

            alert("í™”ë©´ì´ 3ì´ˆê°„ ê¹¨ë—í•´ì§‘ë‹ˆë‹¤. \ní°ì˜ ìº¡ì³ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”!");
        }
    </script>
</body>
</html>