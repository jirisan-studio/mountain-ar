<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR ì‚°ë´‰ìš°ë¦¬ ê²€ìƒ‰</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        
        /* ì „ì²´ UI ì»¨í…Œì´ë„ˆ */
        #ui-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* 1. ìƒë‹¨ í† ê¸€ ë²„íŠ¼ (í•­ìƒ ë³´ì„) */
        #toggle-btn {
            position: absolute;
            top: 10px; left: 10px;
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            color: white;
            border: 1px solid white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* 2. ê²€ìƒ‰ íŒ¨ë„ (í† ê¸€ ê°€ëŠ¥) */
        #search-panel {
            pointer-events: auto;
            position: absolute;
            top: 50px; left: 10px;
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            display: flex; /* ê¸°ë³¸: ì„¸ë¡œ ë°°ì¹˜ */
            flex-direction: column; 
            gap: 10px;
            transition: all 0.3s ease;
        }

        /* ìˆ¨ê¹€ í´ë˜ìŠ¤ */
        .hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
        }

        input[type="text"] {
            padding: 10px;
            border-radius: 5px;
            border: none;
            width: 90%;
        }

        .btn-group {
            display: flex;
            gap: 5px;
        }

        button.action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        #btn-search { background-color: #ff9800; }
        #btn-test { background-color: #2196F3; }

        #status-msg {
            color: #00ff00;
            font-size: 12px;
            line-height: 1.4;
        }

        /* 3. ìŠ¬ë¼ì´ë” (ì˜¤ë¥¸ìª½) */
        .slider-wrapper {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            height: 200px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        input[type=range] {
            writing-mode: bt-lr; 
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 100%;
        }

        /* â˜… ê°€ë¡œ ëª¨ë“œ (Landscape) ìµœì í™” â˜… */
        @media (orientation: landscape) {
            #search-panel {
                width: 90%; /* ê°€ë¡œë¡œ ë„“ê²Œ */
                left: 5%;
                top: 10px;
                flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ë¡œ ë³€ê²½ */
                align-items: center;
                padding: 5px 10px;
            }
            
            #toggle-btn { display: none; } /* ê°€ë¡œì—ì„  í† ê¸€ ë²„íŠ¼ ìˆ¨ê¸°ê³  ê·¸ëƒ¥ ë°” í˜•íƒœë¡œ */
            
            input[type="text"] { width: 40%; margin-right: 5px; }
            .btn-group { width: 30%; }
            #status-msg { width: 30%; font-size: 11px; margin-left: 10px; text-align: left;}
        }
    </style>
</head>

<body>
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="logarithmicDepthBuffer: true; precision: medium;">

        <a-camera gps-camera="minDistance: 5;" rotation-reader></a-camera>
        <a-entity id="places-container"></a-entity>
    </a-scene>

    <div id="ui-layer">
        <!-- í† ê¸€ ë²„íŠ¼ -->
        <button id="toggle-btn" onclick="toggleUI()">ğŸ‘ ê²€ìƒ‰ì°½ ë‹«ê¸°</button>

        <!-- ê²€ìƒ‰ íŒ¨ë„ -->
        <div id="search-panel">
            <input type="text" id="mt-input" placeholder="ì‚° ì´ë¦„ (ì˜ˆ: ì§€ë¦¬ì‚°)">
            
            <div class="btn-group">
                <button id="btn-search" class="action-btn" onclick="searchMountain()">ê²€ìƒ‰</button>
                <button id="btn-test" class="action-btn" onclick="addTestPin()">í…ŒìŠ¤íŠ¸í•€</button>
            </div>

            <div id="status-msg">GPS ì‹ í˜¸ ëŒ€ê¸°ì¤‘...</div>
        </div>

        <!-- ìŠ¬ë¼ì´ë” -->
        <div class="slider-wrapper">
            <div style="color:white; font-weight:bold; margin-bottom:5px;"><span id="range-val">50</span>km</div>
            <input type="range" id="dist-slider" min="1" max="50" value="50" step="1">
        </div>
    </div>

    <script>
        const API_KEY = "aefb2d81d98a261063b5a55e928504fd246622cdc34f474da0ffc56447df5e4a";
        const API_URL = "https://apis.data.go.kr/B553662/peakPoiInfoService/getPeakPoiInfoList";

        let userLat = 0;
        let userLng = 0;
        let currentData = [];

        // UI í† ê¸€ ê¸°ëŠ¥
        function toggleUI() {
            const panel = document.getElementById('search-panel');
            const btn = document.getElementById('toggle-btn');
            panel.classList.toggle('hidden');
            if(panel.classList.contains('hidden')) {
                btn.innerText = "ğŸ” ê²€ìƒ‰ì°½ ì—´ê¸°";
            } else {
                btn.innerText = "ğŸ‘ ê²€ìƒ‰ì°½ ë‹«ê¸°";
            }
        }

        window.onload = () => {
            // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
            document.getElementById('dist-slider').addEventListener('input', (e) => {
                document.getElementById('range-val').innerText = e.target.value;
                renderPlaces(e.target.value);
            });

            // GPS ì‹œì‘
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    document.getElementById('status-msg').innerText = `âœ… GPS ì—°ê²°ë¨\n(${userLat.toFixed(4)}, ${userLng.toFixed(4)})`;
                    
                    // ìœ„ì¹˜ ê°±ì‹  ì‹œ ì¬ë Œë”ë§
                    if(currentData.length > 0) renderPlaces(document.getElementById('dist-slider').value);
                }, err => {
                    document.getElementById('status-msg').innerText = "âŒ GPS ê¶Œí•œ ì—†ìŒ";
                }, { enableHighAccuracy: true });
            }
        };

        // â˜… í…ŒìŠ¤íŠ¸ í•€ ì¶”ê°€ (AR ì‘ë™ ì—¬ë¶€ í™•ì¸ìš©) â˜…
        function addTestPin() {
            if(userLat === 0) { alert("GPSê°€ ì¡í˜€ì•¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
            
            // ë‚´ ìœ„ì¹˜ì—ì„œ ë¶ìª½ìœ¼ë¡œ 0.002ë„ (ì•½ 200m) ë–¨ì–´ì§„ ê³³ì— ê°€ì§œ ì‚° ìƒì„±
            const testData = {
                name: "í…ŒìŠ¤íŠ¸ í•€",
                mtName: "(ë‚´ ì• 200m)",
                lat: userLat + 0.002,
                lng: userLng,
                alt: 100
            };
            currentData = [testData]; // ê¸°ì¡´ ë°ì´í„° ì§€ìš°ê³  í…ŒìŠ¤íŠ¸ ë°ì´í„°ë§Œ
            renderPlaces(50);
            alert("ë¶ìª½(N) ë°©í–¥ì„ ë³´ì„¸ìš”. ë¹¨ê°„ í•€ì´ ë³´ì´ë©´ AR ì •ìƒì…ë‹ˆë‹¤.");
            
            // ëª¨ë°”ì¼ì—ì„œ í‚¤íŒ¨ë“œ ë‹«ê¸°
            document.getElementById('mt-input').blur();
            // UI ìˆ¨ê¸°ê¸°
            toggleUI(); 
        }

        function searchMountain() {
            const keyword = document.getElementById('mt-input').value;
            if(!keyword) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
            if(userLat === 0) { alert("GPS ìˆ˜ì‹  ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤."); return; }

            const status = document.getElementById('status-msg');
            status.innerText = "API ìš”ì²­ ì¤‘...";

            // í‚¤íŒ¨ë“œ ë‹«ê¸°
            document.getElementById('mt-input').blur();

            const queryParams = `?serviceKey=${API_KEY}&numOfRows=100&pageNo=1&type=json&srchFrtrlNm=${encodeURIComponent(keyword)}&srchPlaceTpeCd=PEAK`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(API_URL + queryParams)}`;

            fetch(proxyUrl)
                .then(res => res.json())
                .then(data => {
                    const items = data.response?.body?.items?.item;
                    if (items) {
                        const list = Array.isArray(items) ? items : [items];
                        currentData = list.map(item => ({
                            name: item.placeNm,
                            mtName: item.frtrlNm,
                            lat: parseFloat(item.lat),
                            lng: parseFloat(item.lot),
                            alt: item.aslAltide
                        }));
                        status.innerText = `ê²°ê³¼: ${currentData.length}ê°œ ë°œê²¬!`;
                        renderPlaces(document.getElementById('dist-slider').value);
                        
                        // ê²€ìƒ‰ ì„±ê³µ ì‹œ UI ë‹«ì•„ì„œ í™”ë©´ ë³´ì—¬ì£¼ê¸°
                        setTimeout(() => toggleUI(), 1000); 
                    } else {
                        status.innerText = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                        currentData = [];
                        renderPlaces(50);
                    }
                })
                .catch(err => {
                    console.error(err);
                    status.innerText = "í†µì‹  ì˜¤ë¥˜ ë°œìƒ";
                });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function renderPlaces(rangeKm) {
            const container = document.getElementById('places-container');
            container.innerHTML = ''; 

            currentData.forEach(place => {
                const dist = calculateDistance(userLat, userLng, place.lat, place.lng);

                if (dist <= rangeKm) {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gps-entity-place', `latitude: ${place.lat}; longitude: ${place.lng};`);
                    entity.setAttribute('look-at', '[gps-camera]');

                    // ê±°ë¦¬ ë¹„ë¡€ í¬ê¸°
                    const scaleSize = 20 + (dist * 10); 
                    entity.setAttribute('scale', `${scaleSize} ${scaleSize} ${scaleSize}`);

                    // í•€
                    const cone = document.createElement('a-cone');
                    cone.setAttribute('color', 'red');
                    cone.setAttribute('radius-bottom', '0.1'); 
                    cone.setAttribute('radius-top', '1');
                    cone.setAttribute('height', '3');
                    cone.setAttribute('position', '0 5 0'); 

                    // í…ìŠ¤íŠ¸
                    const text = document.createElement('a-text');
                    text.setAttribute('value', `${place.mtName} ${place.name}\n(${dist.toFixed(1)}km)`);
                    text.setAttribute('align', 'center');
                    text.setAttribute('color', 'white');
                    text.setAttribute('position', '0 10 0'); 
                    text.setAttribute('geometry', 'primitive: plane; width: auto; height: auto;');
                    text.setAttribute('material', 'color: black; opacity: 0.6;');

                    entity.appendChild(cone);
                    entity.appendChild(text);
                    container.appendChild(entity);
                }
            });
        }
    </script>
</body>
</html>