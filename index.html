<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR ì‚°ë´‰ìš°ë¦¬ ê²€ìƒ‰</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        
        #ui-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* ì‹œì‘í•˜ê¸°(ì„¼ì„œ ê¶Œí•œ) ì˜¤ë²„ë ˆì´ */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            color: white;
            text-align: center;
        }

        #start-btn {
            padding: 15px 30px;
            font-size: 20px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 30px;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        }

        #toggle-btn {
            position: absolute;
            top: 10px; left: 10px;
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            color: white;
            border: 1px solid white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        #search-panel {
            pointer-events: auto;
            position: absolute;
            top: 50px; left: 10px;
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column; 
            gap: 10px;
            transition: all 0.3s ease;
        }

        .hidden { opacity: 0; pointer-events: none; transform: translateY(-20px); }

        input[type="text"] { padding: 10px; border-radius: 5px; border: none; width: 90%; }

        .btn-group { display: flex; gap: 5px; }
        button.action-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
        #btn-search { background-color: #ff9800; }
        #btn-test { background-color: #2196F3; }

        #status-msg { color: #00ff00; font-size: 12px; line-height: 1.4; }

        .slider-wrapper {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            height: 200px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        input[type=range] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 8px; height: 100%; }

        @media (orientation: landscape) {
            #search-panel {
                width: 90%; left: 5%; top: 10px;
                flex-direction: row; align-items: center; padding: 5px 10px;
            }
            #toggle-btn { display: none; }
            input[type="text"] { width: 40%; margin-right: 5px; }
            .btn-group { width: 30%; }
            #status-msg { width: 30%; font-size: 11px; margin-left: 10px; text-align: left;}
        }
    </style>
</head>

<body>
    <!-- ì‹œì‘ ì˜¤ë²„ë ˆì´ (ì„¼ì„œ ê¶Œí•œìš©) -->
    <div id="start-overlay">
        <h2>AR ì‚°ë´‰ìš°ë¦¬ ì°¾ê¸°</h2>
        <p>ì •í™•í•œ ìœ„ì¹˜ í‘œì‹œë¥¼ ìœ„í•´<br>ë‚˜ì¹¨ë°˜/ì„¼ì„œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        <button id="start-btn" onclick="requestPermissions()">AR ì‹œì‘í•˜ê¸°</button>
        <p style="font-size:12px; color:#aaa; margin-top:20px;">
            * ë¸Œë ˆì´ë¸Œ ë¸Œë¼ìš°ì €ëŠ” ì£¼ì†Œì°½ ì‚¬ì ì•„ì´ì½˜(Shields)ì—ì„œ<br>
            'ëª¨ì…˜ ì„¼ì„œ ì°¨ë‹¨'ì„ í•´ì œí•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="logarithmicDepthBuffer: true; precision: medium;">

        <a-camera gps-camera="minDistance: 5;" rotation-reader></a-camera>
        <a-entity id="places-container"></a-entity>
    </a-scene>

    <div id="ui-layer">
        <button id="toggle-btn" onclick="toggleUI()">ğŸ‘ ê²€ìƒ‰ì°½ ë‹«ê¸°</button>

        <div id="search-panel">
            <input type="text" id="mt-input" placeholder="ì‚° ì´ë¦„ (ì˜ˆ: ì§€ë¦¬ì‚°)">
            <div class="btn-group">
                <button id="btn-search" class="action-btn" onclick="searchMountain()">ê²€ìƒ‰</button>
                <button id="btn-test" class="action-btn" onclick="addTestPin()">í…ŒìŠ¤íŠ¸í•€</button>
            </div>
            <div id="status-msg">GPS ì‹ í˜¸ ëŒ€ê¸°ì¤‘...</div>
        </div>

        <div class="slider-wrapper">
            <div style="color:white; font-weight:bold; margin-bottom:5px;"><span id="range-val">50</span>km</div>
            <input type="range" id="dist-slider" min="1" max="50" value="50" step="1">
        </div>
    </div>

    <script>
        const API_KEY = "aefb2d81d98a261063b5a55e928504fd246622cdc34f474da0ffc56447df5e4a";
        const API_URL = "https://apis.data.go.kr/B553662/peakPoiInfoService/getPeakPoiInfoList";

        let userLat = 0;
        let userLng = 0;
        let currentData = [];

        // â˜… ì„¼ì„œ ê¶Œí•œ ìš”ì²­ í•¨ìˆ˜ (ë¸Œë ˆì´ë¸Œ/iOS ëŒ€ì‘) â˜…
        function requestPermissions() {
            // 1. ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            document.getElementById('start-overlay').style.display = 'none';

            // 2. iOS 13+ ë° ì¼ë¶€ ë¸Œë¼ìš°ì €ë¥¼ ìœ„í•œ ê¶Œí•œ ìš”ì²­
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') {
                            // ê¶Œí•œ í—ˆìš©ë¨
                            initGPS();
                        } else {
                            alert('ì„¼ì„œ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ARì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        }
                    })
                    .catch(console.error);
            } else {
                // ì•ˆë“œë¡œì´ë“œ/ì¼ë°˜ í¬ë¡¬ì€ ìë™ í—ˆìš©
                initGPS();
            }
        }

        function initGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    document.getElementById('status-msg').innerText = `âœ… GPS ì—°ê²°ë¨\n(${userLat.toFixed(4)}, ${userLng.toFixed(4)})`;
                    
                    if(currentData.length > 0) renderPlaces(document.getElementById('dist-slider').value);
                }, err => {
                    document.getElementById('status-msg').innerText = "âŒ GPS ê¶Œí•œ ì—†ìŒ";
                }, { enableHighAccuracy: true });
            }
        }

        function toggleUI() {
            const panel = document.getElementById('search-panel');
            const btn = document.getElementById('toggle-btn');
            panel.classList.toggle('hidden');
            btn.innerText = panel.classList.contains('hidden') ? "ğŸ” ê²€ìƒ‰ì°½ ì—´ê¸°" : "ğŸ‘ ê²€ìƒ‰ì°½ ë‹«ê¸°";
        }

        window.onload = () => {
            document.getElementById('dist-slider').addEventListener('input', (e) => {
                document.getElementById('range-val').innerText = e.target.value;
                renderPlaces(e.target.value);
            });
            // requestPermissions()ëŠ” ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë¨
        };

        function addTestPin() {
            if(userLat === 0) { alert("GPSê°€ ì¡í˜€ì•¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
            
            const testData = {
                name: "í…ŒìŠ¤íŠ¸ í•€",
                mtName: "(ë‚´ ì• 200m)",
                lat: userLat + 0.002,
                lng: userLng,
                alt: 100
            };
            currentData = [testData];
            renderPlaces(50);
            alert("ë¶ìª½(N) ë°©í–¥ì„ ë³´ì„¸ìš”. ë¹¨ê°„ í•€ì´ ë³´ì´ë©´ AR ì •ìƒì…ë‹ˆë‹¤.");
            document.getElementById('mt-input').blur();
            toggleUI(); 
        }

        function searchMountain() {
            const keyword = document.getElementById('mt-input').value;
            if(!keyword) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
            if(userLat === 0) { alert("GPS ìˆ˜ì‹  ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤."); return; }

            const status = document.getElementById('status-msg');
            status.innerText = "API ìš”ì²­ ì¤‘...";
            document.getElementById('mt-input').blur();

            const queryParams = `?serviceKey=${API_KEY}&numOfRows=100&pageNo=1&type=json&srchFrtrlNm=${encodeURIComponent(keyword)}&srchPlaceTpeCd=PEAK`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(API_URL + queryParams)}`;

            fetch(proxyUrl)
                .then(res => res.json())
                .then(data => {
                    const items = data.response?.body?.items?.item;
                    if (items) {
                        const list = Array.isArray(items) ? items : [items];
                        currentData = list.map(item => ({
                            name: item.placeNm,
                            mtName: item.frtrlNm,
                            lat: parseFloat(item.lat),
                            lng: parseFloat(item.lot),
                            alt: item.aslAltide
                        }));
                        status.innerText = `ê²°ê³¼: ${currentData.length}ê°œ ë°œê²¬!`;
                        renderPlaces(document.getElementById('dist-slider').value);
                        setTimeout(() => toggleUI(), 1000); 
                    } else {
                        status.innerText = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                        currentData = [];
                        renderPlaces(50);
                    }
                })
                .catch(err => {
                    console.error(err);
                    status.innerText = "í†µì‹  ì˜¤ë¥˜ ë°œìƒ";
                });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function renderPlaces(rangeKm) {
            const container = document.getElementById('places-container');
            container.innerHTML = ''; 

            currentData.forEach(place => {
                const dist = calculateDistance(userLat, userLng, place.lat, place.lng);

                if (dist <= rangeKm) {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gps-entity-place', `latitude: ${place.lat}; longitude: ${place.lng};`);
                    entity.setAttribute('look-at', '[gps-camera]');

                    const scaleSize = 20 + (dist * 10); 
                    entity.setAttribute('scale', `${scaleSize} ${scaleSize} ${scaleSize}`);

                    const cone = document.createElement('a-cone');
                    cone.setAttribute('color', 'red');
                    cone.setAttribute('radius-bottom', '0.1'); 
                    cone.setAttribute('radius-top', '1');
                    cone.setAttribute('height', '3');
                    cone.setAttribute('position', '0 5 0'); 

                    const text = document.createElement('a-text');
                    text.setAttribute('value', `${place.mtName} ${place.name}\n(${dist.toFixed(1)}km)`);
                    text.setAttribute('align', 'center');
                    text.setAttribute('color', 'white');
                    text.setAttribute('position', '0 10 0'); 
                    text.setAttribute('geometry', 'primitive: plane; width: auto; height: auto;');
                    text.setAttribute('material', 'color: black; opacity: 0.6;');

                    entity.appendChild(cone);
                    entity.appendChild(text);
                    container.appendChild(entity);
                }
            });
        }
    </script>
</body>
</html>