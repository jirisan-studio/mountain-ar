<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì „êµ­ ì‚°ë´‰ìš°ë¦¬ AR</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        
        #ui-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #info-panel {
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 15px;
            font-size: 14px;
            text-align: left;
            position: absolute;
            top: 10px; left: 10px;
            border-radius: 10px;
            pointer-events: auto;
            max-width: 80%;
            backdrop-filter: blur(5px);
        }

        .loader {
            display: inline-block;
            width: 15px;
            height: 15px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .slider-wrapper {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            border-radius: 20px;
            padding: 15px 5px;
        }

        input[type=range] {
            writing-mode: bt-lr; 
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 100%;
        }

        .range-label {
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
        }

        #capture-btn {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            width: 70px;
            height: 70px;
            background-color: white;
            border-radius: 50%;
            border: 5px solid rgba(200,200,200,0.5);
            pointer-events: auto;
            cursor: pointer;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (orientation: landscape) {
            .slider-wrapper { right: 40px; }
            #capture-btn { bottom: 20px; }
        }
    </style>
</head>

<body>
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="logarithmicDepthBuffer: true; precision: medium;">

        <a-camera gps-camera="minDistance: 5;" rotation-reader></a-camera>
        <a-entity id="places-container"></a-entity>
    </a-scene>

    <div id="ui-container">
        <div id="info-panel">
            <strong>ìœ„ì¹˜ íƒìƒ‰ ì¤‘...</strong><br>
            <span style="font-size:12px; color:#ccc;">GPS ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</span>
        </div>

        <div class="slider-wrapper">
            <div class="range-label"><span id="range-val">20</span>km</div>
            <!-- ë°ì´í„° ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ê¸°ë³¸ 20km, ìµœëŒ€ 50km -->
            <input type="range" id="dist-slider" min="1" max="50" value="20" step="1">
        </div>

        <button id="capture-btn">ğŸ“·</button>
    </div>

    <script>
        let userLat = 0;
        let userLng = 0;
        let loadedData = []; // APIë¡œ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ì €ì¥í•  ê³³
        let isDataLoaded = false;

        window.onload = () => {
            const slider = document.getElementById('dist-slider');
            slider.addEventListener('change', (e) => {
                // ìŠ¬ë¼ì´ë” ì¡°ì‘ì´ ëë‚˜ë©´(ì† ë–¼ë©´) ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                document.getElementById('range-val').innerText = e.target.value;
                if(userLat !== 0) fetchOSMData(userLat, userLng, e.target.value);
            });
            
            slider.addEventListener('input', (e) => {
                 // ìŠ¬ë¼ì´ë” ì›€ì§ì´ëŠ” ë™ì•ˆ ìˆ«ìë§Œ ë³€ê²½
                 document.getElementById('range-val').innerText = e.target.value;
            });

            document.getElementById('capture-btn').addEventListener('click', takeScreenshot);

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    
                    // ìµœì´ˆ 1íšŒë§Œ ë°ì´í„° ë¡œë”©
                    if (!isDataLoaded) {
                        fetchOSMData(userLat, userLng, slider.value);
                        isDataLoaded = true;
                    }

                    // ìœ„ì¹˜ê°€ ë°”ë€Œë©´ AR ê±°ë¦¬ ì—…ë°ì´íŠ¸ (ë°ì´í„° ì¬ë¡œë”©ì€ ì•ˆí•¨)
                    if(loadedData.length > 0) {
                        updateARObjects(slider.value);
                    }
                    
                }, error => {
                    document.getElementById('info-panel').innerHTML = "ğŸš¨ GPS ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.";
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 27000
                });
            }
        };

        // â˜… í•µì‹¬: OpenStreetMap(Overpass API)ì—ì„œ ì£¼ë³€ ì‚° ì •ë³´ ê°€ì ¸ì˜¤ê¸° â˜…
        function fetchOSMData(lat, lng, radiusKm) {
            const panel = document.getElementById('info-panel');
            panel.innerHTML = `<div class="loader"></div> ì£¼ë³€ ì‚° ê²€ìƒ‰ ì¤‘... (${radiusKm}km)`;

            const radiusMeters = radiusKm * 1000;
            
            // Overpass QL ì¿¼ë¦¬: ë‚´ ì£¼ë³€(around)ì˜ natural=peak(ë´‰ìš°ë¦¬) ë˜ëŠ” natural=saddle(ê³ ê°œ) ê²€ìƒ‰
            // ì´ë¦„(name)ì´ ìˆëŠ” ê²ƒë§Œ ê°€ì ¸ì˜´
            const query = `
                [out:json][timeout:25];
                (
                  node["natural"="peak"]["name"](around:${radiusMeters}, ${lat}, ${lng});
                  node["natural"="saddle"]["name"](around:${radiusMeters}, ${lat}, ${lng});
                  node["natural"="bare_rock"]["name"](around:${radiusMeters}, ${lat}, ${lng});
                );
                out body;
            `;

            const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    loadedData = []; // ì´ˆê¸°í™”
                    
                    if(data.elements && data.elements.length > 0) {
                        data.elements.forEach(el => {
                            loadedData.push({
                                name: el.tags.name,
                                lat: el.lat,
                                lng: el.lon,
                                type: el.tags.natural // peak, saddle ë“± êµ¬ë¶„ ê°€ëŠ¥
                            });
                        });
                        
                        panel.innerHTML = `âœ… <strong>${loadedData.length}ê°œ</strong>ì˜ ë´‰ìš°ë¦¬/ê³ ê°œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.<br>
                                           <span style="font-size:12px">ë‚´ ìœ„ì¹˜: ${lat.toFixed(4)}, ${lng.toFixed(4)}</span>`;
                        
                        // AR ì˜¤ë¸Œì íŠ¸ ìƒì„±
                        updateARObjects(radiusKm);
                    } else {
                        panel.innerHTML = `âš ï¸ ì£¼ë³€ ${radiusKm}km ë‚´ì— ë“±ë¡ëœ ì‚°ì´ ì—†ìŠµë‹ˆë‹¤.`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    panel.innerHTML = "âŒ ë°ì´í„° ìˆ˜ì‹  ì‹¤íŒ¨ (ì¸í„°ë„· í™•ì¸)";
                });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function updateARObjects(rangeKm) {
            const container = document.getElementById('places-container');
            container.innerHTML = ''; // ê¸°ì¡´ í•€ ì‚­ì œ

            loadedData.forEach(place => {
                const dist = calculateDistance(userLat, userLng, place.lat, place.lng);

                if (dist <= rangeKm) {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gps-entity-place', `latitude: ${place.lat}; longitude: ${place.lng};`);
                    entity.setAttribute('look-at', '[gps-camera]');

                    // ê±°ë¦¬ ë¹„ë¡€ í¬ê¸° ì¡°ì ˆ
                    const scaleSize = 20 + (dist * 10); 
                    entity.setAttribute('scale', `${scaleSize} ${scaleSize} ${scaleSize}`);

                    // 1. í•€ (ë´‰ìš°ë¦¬ëŠ” ë¹¨ê°•, ê³ ê°œ/ê¸°íƒ€ëŠ” íŒŒë‘)
                    const cone = document.createElement('a-cone');
                    const pinColor = (place.type === 'peak') ? 'red' : '#0099ff'; // ë´‰ìš°ë¦¬=ë¹¨ê°•, ê³ ê°œ=íŒŒë‘
                    
                    cone.setAttribute('color', pinColor);
                    cone.setAttribute('radius-bottom', '0.1'); 
                    cone.setAttribute('radius-top', '1');
                    cone.setAttribute('height', '3');
                    cone.setAttribute('position', '0 5 0'); 
                    cone.setAttribute('opacity', '0.9');

                    // 2. í…ìŠ¤íŠ¸
                    const text = document.createElement('a-text');
                    text.setAttribute('value', `${place.name}\n(${dist.toFixed(1)}km)`);
                    text.setAttribute('align', 'center');
                    text.setAttribute('color', 'white');
                    text.setAttribute('position', '0 8 0'); 
                    
                    // í…ìŠ¤íŠ¸ ë°°ê²½
                    text.setAttribute('geometry', 'primitive: plane; width: auto; height: auto;');
                    text.setAttribute('material', 'color: black; opacity: 0.6;');

                    entity.appendChild(cone);
                    entity.appendChild(text);
                    container.appendChild(entity);
                }
            });
        }

        function takeScreenshot() {
            const ui = document.getElementById('ui-container');
            ui.style.display = 'none';
            setTimeout(() => { ui.style.display = 'flex'; }, 3000);
        }
    </script>
</body>
</html>