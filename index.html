<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>실시간 산봉우리 검색 AR</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        
        #ui-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* 검색창 영역 */
        #search-box {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            display: flex;
            gap: 5px;
        }
        
        #mt-input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }

        #search-btn {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            background-color: #ff9800;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        #status-msg {
            color: white;
            font-size: 12px;
            margin-top: 5px;
        }

        /* 슬라이더 */
        .slider-wrapper {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            padding: 15px 5px;
        }

        input[type=range] {
            writing-mode: bt-lr; 
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 100%;
        }

        .range-label {
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
        }

        @media (orientation: landscape) {
            .slider-wrapper { right: 40px; }
        }
    </style>
</head>

<body>
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="logarithmicDepthBuffer: true; precision: medium;">

        <a-camera gps-camera="minDistance: 5;" rotation-reader></a-camera>
        <a-entity id="places-container"></a-entity>
    </a-scene>

    <div id="ui-container">
        <!-- 검색창 -->
        <div id="search-box">
            <div style="width:100%">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="mt-input" placeholder="산 이름 (예: 지리산, 만복대)">
                    <button id="search-btn" onclick="searchMountain()">검색</button>
                </div>
                <div id="status-msg">GPS 수신 대기중...</div>
            </div>
        </div>

        <!-- 거리 조절 슬라이더 -->
        <div class="slider-wrapper">
            <div class="range-label"><span id="range-val">50</span>km</div>
            <input type="range" id="dist-slider" min="1" max="50" value="50" step="1">
        </div>
    </div>

    <script>
        // ★ API 설정 (사용자님의 Decoding 키 적용됨)
        const API_KEY = "aefb2d81d98a261063b5a55e928504fd246622cdc34f474da0ffc56447df5e4a";
        const API_URL = "https://apis.data.go.kr/B553662/peakPoiInfoService/getPeakPoiInfoList";

        let userLat = 0;
        let userLng = 0;
        let currentData = [];

        window.onload = () => {
            const slider = document.getElementById('dist-slider');
            slider.addEventListener('input', (e) => {
                document.getElementById('range-val').innerText = e.target.value;
                renderPlaces(e.target.value); // 슬라이더 움직이면 즉시 거리 필터링
            });

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    document.getElementById('status-msg').innerText = `내 위치: ${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
                    
                    // 위치가 갱신되면 AR 핀 거리정보 업데이트
                    if(currentData.length > 0) renderPlaces(slider.value);

                }, error => {
                    document.getElementById('status-msg').innerText = "GPS 권한이 필요합니다.";
                }, { enableHighAccuracy: true });
            }
        };

        // ★ 오픈API 호출 함수 (프록시 사용) ★
        function searchMountain() {
            const keyword = document.getElementById('mt-input').value;
            if(!keyword) { alert("산 이름을 입력하세요"); return; }

            const status = document.getElementById('status-msg');
            status.innerText = `'${keyword}' 검색 중...`;

            // CORS 우회를 위한 프록시 URL (allorigins.win 사용)
            // 실제 요청: Proxy -> 공공데이터포털 -> Proxy -> 내 폰
            const queryParams = `?serviceKey=${API_KEY}&numOfRows=100&pageNo=1&type=json&srchFrtrlNm=${encodeURIComponent(keyword)}&srchPlaceTpeCd=PEAK`;
            const targetUrl = API_URL + queryParams;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;

            fetch(proxyUrl)
                .then(response => response.json())
                .then(data => {
                    console.log(data); // 디버깅용
                    const items = data.response?.body?.items?.item;

                    if (items) {
                        // 결과가 1개일 경우 배열로 변환
                        const list = Array.isArray(items) ? items : [items];
                        
                        // 데이터 파싱
                        currentData = list.map(item => ({
                            name: item.placeNm,        // 봉우리 이름 (예: 천왕봉)
                            mtName: item.frtrlNm,      // 산 이름 (예: 지리산)
                            lat: parseFloat(item.lat),
                            lng: parseFloat(item.lot), // API 명세상 lot가 경도
                            alt: item.aslAltide        // 해발고도
                        }));

                        status.innerText = `검색 완료! ${currentData.length}개의 봉우리를 찾았습니다.`;
                        renderPlaces(document.getElementById('dist-slider').value);
                    } else {
                        status.innerText = "검색 결과가 없습니다. (정확한 산/봉우리 이름을 입력하세요)";
                        currentData = [];
                        renderPlaces(50);
                    }
                })
                .catch(err => {
                    console.error(err);
                    status.innerText = "API 호출 실패 (통신 오류)";
                });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function renderPlaces(rangeKm) {
            const container = document.getElementById('places-container');
            container.innerHTML = ''; 

            currentData.forEach(place => {
                const dist = calculateDistance(userLat, userLng, place.lat, place.lng);

                if (dist <= rangeKm) {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gps-entity-place', `latitude: ${place.lat}; longitude: ${place.lng};`);
                    entity.setAttribute('look-at', '[gps-camera]');

                    // 거리 비례 크기 (멀수록 크게)
                    const scaleSize = 20 + (dist * 10); 
                    entity.setAttribute('scale', `${scaleSize} ${scaleSize} ${scaleSize}`);

                    // 1. 핀
                    const cone = document.createElement('a-cone');
                    cone.setAttribute('color', 'red');
                    cone.setAttribute('radius-bottom', '0.1'); 
                    cone.setAttribute('radius-top', '1');
                    cone.setAttribute('height', '3');
                    cone.setAttribute('position', '0 5 0'); 

                    // 2. 텍스트 (산이름 + 봉우리명)
                    const text = document.createElement('a-text');
                    // 예: 지리산 천왕봉 (10.5km)
                    text.setAttribute('value', `${place.mtName} ${place.name}\n(${dist.toFixed(1)}km)`);
                    text.setAttribute('align', 'center');